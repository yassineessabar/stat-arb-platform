name: Strategy Monitoring & Alerts

on:
  # Disabled scheduled monitoring due to Binance geo-restrictions
  # schedule:
  #   - cron: '0 * * * *'
  #   - cron: '0 0 * * *'

  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - positions
          - performance
          - health

jobs:
  monitor-positions:
    name: Monitor Open Positions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install supabase pandas numpy requests

      - name: Check Open Positions
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          ALERT_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        if: ${{ secrets.SUPABASE_URL != '' }}
        run: |
          python3 << 'MONITOR_SCRIPT'
          import os
          import json
          import os
          import pandas as pd
          from datetime import datetime, timedelta

          # Check if secrets are configured
          if not os.environ.get('SUPABASE_URL'):
              print("‚ö†Ô∏è Monitoring skipped: SUPABASE_URL not configured")
              print("Please add secrets to enable monitoring")
              exit(0)

          from supabase import create_client

          # Connect to database
          supabase = create_client(
              os.environ['SUPABASE_URL'],
              os.environ['SUPABASE_SERVICE_KEY']
          )

          # Get open positions
          positions = supabase.table('positions') \
              .select('*') \
              .eq('status', 'open') \
              .execute()

          if positions.data:
              print(f"üìä Open Positions: {len(positions.data)}")

              # Check for concerning positions
              alerts = []
              for pos in positions.data:
                  # Check if position is too old (>24 hours)
                  entry_time = pd.to_datetime(pos['entry_time'])
                  age_hours = (datetime.now() - entry_time).total_seconds() / 3600

                  if age_hours > 24:
                      alerts.append(f"‚ö†Ô∏è Old position: {pos['symbol_1']}/{pos['symbol_2']} open for {age_hours:.1f} hours")

                  # Check if z-score has moved against us
                  if abs(pos.get('entry_z_score', 0)) > 3.5:
                      alerts.append(f"üö® High risk position: {pos['symbol_1']}/{pos['symbol_2']} z-score: {pos['entry_z_score']:.2f}")

              if alerts:
                  print("\n‚ö†Ô∏è ALERTS:")
                  for alert in alerts:
                      print(f"  {alert}")

                  # Send Discord alert if configured
                  if os.environ.get('ALERT_WEBHOOK'):
                      import requests
                      webhook_data = {
                          "content": f"**Strategy Alerts** ({datetime.now():%Y-%m-%d %H:%M} UTC)",
                          "embeds": [{
                              "title": "Position Monitoring Alert",
                              "description": "\n".join(alerts),
                              "color": 16776960  # Yellow
                          }]
                      }
                      requests.post(os.environ['ALERT_WEBHOOK'], json=webhook_data)
          else:
              print("‚úÖ No open positions")
          MONITOR_SCRIPT

  performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *' || github.event.inputs.check_type == 'performance'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install supabase pandas numpy requests matplotlib

      - name: Generate Daily Report
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        if: ${{ secrets.SUPABASE_URL != '' }}
        run: |
          python3 << 'REPORT_SCRIPT'
          import os
          import pandas as pd
          import numpy as np
          from datetime import datetime, timedelta
          from supabase import create_client

          # Connect to database
          supabase = create_client(
              os.environ['SUPABASE_URL'],
              os.environ['SUPABASE_SERVICE_KEY']
          )

          # Get trades from last 24 hours
          yesterday = (datetime.now() - timedelta(days=1)).isoformat()

          trades = supabase.table('trades') \
              .select('*') \
              .gte('exit_time', yesterday) \
              .execute()

          if trades.data:
              df = pd.DataFrame(trades.data)

              # Calculate metrics
              total_trades = len(df)
              total_pnl = df['realized_pnl'].sum()
              winning_trades = len(df[df['realized_pnl'] > 0])
              losing_trades = len(df[df['realized_pnl'] < 0])
              win_rate = winning_trades / total_trades if total_trades > 0 else 0
              avg_win = df[df['realized_pnl'] > 0]['realized_pnl'].mean() if winning_trades > 0 else 0
              avg_loss = df[df['realized_pnl'] < 0]['realized_pnl'].mean() if losing_trades > 0 else 0
              profit_factor = abs(avg_win * winning_trades / (avg_loss * losing_trades)) if losing_trades > 0 else float('inf')

              # Generate report
              report = f"""
              üìä DAILY PERFORMANCE REPORT
              ============================
              Date: {datetime.now():%Y-%m-%d}

              SUMMARY METRICS:
              ----------------
              Total Trades:    {total_trades}
              Total P&L:       ${total_pnl:,.2f}
              Win Rate:        {win_rate:.1%}
              Profit Factor:   {profit_factor:.2f}

              TRADE BREAKDOWN:
              ----------------
              Winning Trades:  {winning_trades} (${avg_win:,.2f} avg)
              Losing Trades:   {losing_trades} (${avg_loss:,.2f} avg)

              TOP PERFORMING PAIRS:
              ---------------------"""

              # Top pairs
              top_pairs = df.groupby('symbol_1')['realized_pnl'].sum().sort_values(ascending=False).head(3)
              for pair, pnl in top_pairs.items():
                  report += f"\n  {pair}: ${pnl:,.2f}"

              print(report)

              # Save report
              with open('daily_report.txt', 'w') as f:
                  f.write(report)

              # Check if we need to send alerts
              if total_pnl < -500:
                  print("\nüö® ALERT: Daily loss exceeds $500!")
                  exit(1)
              elif win_rate < 0.3:
                  print("\n‚ö†Ô∏è WARNING: Win rate below 30%")

          else:
              print("üìä No trades in the last 24 hours")
          REPORT_SCRIPT

      - name: Upload Report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: daily_report.txt
          retention-days: 30

  system-health:
    name: System Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Check Strategy Health
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        if: ${{ secrets.SUPABASE_URL != '' }}
        run: |
          python3 << 'HEALTH_CHECK'
          import os
          from datetime import datetime, timedelta
          from supabase import create_client

          # Connect to database
          supabase = create_client(
              os.environ['SUPABASE_URL'],
              os.environ['SUPABASE_SERVICE_KEY']
          )

          # Check last execution
          one_hour_ago = (datetime.now() - timedelta(hours=1)).isoformat()

          logs = supabase.table('system_logs') \
              .select('*') \
              .gte('timestamp', one_hour_ago) \
              .order('timestamp', desc=True) \
              .limit(1) \
              .execute()

          if logs.data:
              last_log = logs.data[0]
              last_time = pd.to_datetime(last_log['timestamp'])
              minutes_ago = (datetime.now() - last_time).total_seconds() / 60

              print(f"‚úÖ Last execution: {minutes_ago:.0f} minutes ago")

              if minutes_ago > 30:
                  print(f"‚ö†Ô∏è WARNING: No execution in the last 30 minutes!")
                  exit(1)
          else:
              print("‚ùå ERROR: No executions found in the last hour!")
              exit(1)
          HEALTH_CHECK